# FTBacktestParser Design Document (GenTrade Backend)

## Current Context

- **Overview:** This feature extends the backtesting capabilities currently managed by `app/tasks/backtests.py` and `app/db/services/service_backtests.py`. It introduces a utility class `FTBacktestParser` to process Freqtrade backtest results. Freqtrade produces two output files: a summary JSON and a detailed ZIP. This feature extracts, parses, and cleans up these results.
- **Key Components:** `app/tasks/backtests.py`, `app/util/ft/ft_backtesting.py`, `BacktestsORM`, `BacktestsService`, `BacktestsRepository`.
- **Pain Points:** Currently, the backend stores only the path to the backtest result ZIP file. This feature addresses that by:
  - Providing a structured way to access the detailed backtest data contained within the ZIP.
  - Automating the cleanup of temporary files created during the backtest process.
  - Reducing the need for manual file manipulation by users or other backend components.

## Requirements

### Functional Requirements

- **Result Path Input:** The `FTBacktestParser` class MUST accept the path to a backtest result JSON file (e.g., `.../backtest_*.json`) as input to its constructor.
- **ZIP Extraction:** The class MUST locate and extract the associated ZIP file (e.g., `.../backtest_*.zip`) corresponding to the input JSON file.
- **Data Parsing:** The class MUST parse all relevant JSON files contained within the extracted ZIP file, including:
  - The main backtest result JSON.
  - Any additional metadata JSON files.
- **Data Structure:** The class SHOULD provide a structured representation of the parsed data (e.g., using Pydantic models). This design document does not fully specify the internal data representation, but it MUST be accessible in a structured manner.
- **Temporary Directory Handling:** The class MUST create a temporary directory for extraction and automatically remove this directory and its contents after parsing.
- **Error Handling:**
  - The class MUST raise a `FileNotFoundError` if the input JSON file does not exist.
  - The class MUST raise a `FileNotFoundError` if the associated ZIP file does not exist.
  - The class MUST raise a `ValueError` if the input path does not follow the expected Freqtrade naming convention.
  - The class SHOULD handle `zipfile.BadZipFile` and other relevant exceptions during extraction and parsing, raising a custom exception (e.g., `BacktestResultError`) to provide a consistent error interface.
  - Errors during temporary directory cleanup SHOULD be logged but not re-raised.
- **No Modification of Input:** The parser MUST NOT modify or delete the original input JSON file or the ZIP file.

### Non-Functional Requirements

- **Performance:** Extraction and parsing should be efficient to minimize delays in accessing backtest results. Specific performance targets are not defined at this stage but will be informed by usage patterns.
- **Scalability:** This component is not expected to be a scalability bottleneck, as it operates on single files.
- **Observability:** Errors during parsing and temporary directory handling MUST be logged using the project's standard logging mechanism (defined in `app/util/logger.py`).
- **Security:** The component operates on files generated by the backend, so direct user input is not a concern. However, the code should be robust against malformed or corrupted ZIP files.

## Design Decisions

- **Utility Class:** A utility class (`FTBacktestParser`) is chosen over a collection of standalone functions to encapsulate the parsing logic and temporary directory management.
- **Temporary Directory:** Using a temporary directory ensures that incomplete or interrupted extractions do not leave orphaned files. The `tempfile` module is the standard Python library for this purpose.
- **No ORM Interaction:** This parser is purely for file processing and data extraction. It does not interact with the database. Database interaction will be handled by other service, for example service_backtests.py.
- **Exception Handling:** Custom exceptions are used to provide a more specific error context than generic exceptions like `IOError`.
- **Pathlib:** The `pathlib` module is used for file path manipulation for better cross-platform compatibility and more readable code.

## Technical Design

### 1. Core Components

```python
# app/util/ft/ft_backtest_parser.py
import json
import zipfile
import tempfile
import os
from pathlib import Path
from typing import Dict, Any, Optional

from app.util.logger import setup_logger

class BacktestResultError(Exception):
    """Custom exception for errors during backtest result processing."""
    pass

class FTBacktestParser:
    """
    Parses Freqtrade backtest results.  Extracts the associated ZIP file,
    parses JSON data, and cleans up temporary files.
    """

    def __init__(self, result_path: str | Path):
        """
        Initializes the parser with the path to the backtest result JSON file.

        Args:
            result_path: Path to the backtest result JSON file (e.g., .../backtest_*.json).

        Raises:
            FileNotFoundError: If the result_path does not exist.
            ValueError: If the result_path does not follow the expected naming convention.
        """
        self.logger = setup_logger(__name__)
        self.result_path = Path(result_path)
        if not self.result_path.exists():
            self.logger.error(f"Result file not found: {self.result_path}")
            raise FileNotFoundError(f"Result file not found: {self.result_path}")

        if not self.result_path.name.startswith("backtest_") or not self.result_path.suffix == ".json":
            self.logger.error(f"Invalid result file name: {self.result_path.name}")
            raise ValueError(f"Invalid result file name: {self.result_path.name}")

        self.zip_path = self.result_path.with_suffix(".zip")
        if not self.zip_path.exists():
            self.logger.error(f"Associated ZIP file not found: {self.zip_path}")
            raise FileNotFoundError(f"Associated ZIP file not found: {self.zip_path}")

        self.data: Optional[Dict[str, Any]] = None

    def _extract_zip(self) -> Path:
        """
        Extracts the associated ZIP file to a temporary directory.

        Returns:
            Path: The path to the temporary directory containing the extracted files.

        Raises:
            BacktestResultError: If ZIP extraction fails.
        """
        self.logger.debug(f"Extracting backtest result ZIP: {self.zip_path}")
        temp_dir = Path(tempfile.mkdtemp())
        try:
            with zipfile.ZipFile(self.zip_path, 'r') as zip_ref:
                zip_ref.extractall(temp_dir)
            self.logger.debug(f"Extracted ZIP to: {temp_dir}")
            return temp_dir
        except zipfile.BadZipFile as e:
            self.logger.error(f"Failed to extract ZIP file: {self.zip_path} - {e}")
            raise BacktestResultError(f"Failed to extract ZIP file: {self.zip_path}") from e


    def parse_all(self) -> Dict[str, Any]:
        """
        Extracts and parses all data from the backtest result.

        Returns:
            Dict[str, Any]: Parsed backtest data.  The structure of this dictionary
                            is determined by the contents of the backtest result files.
        """

        if self.data:
            return self.data

        temp_dir = self._extract_zip()
        self.data = {}

        try:
            for filename in os.listdir(temp_dir):
                if filename.endswith(".json"):
                    filepath = temp_dir / filename
                    try:
                        with open(filepath, 'r') as f:
                            self.data[filename.replace(".json", "")] = json.load(f)
                    except (OSError, json.JSONDecodeError) as e:
                        self.logger.error(f"Failed to parse {filepath}: {e}")
                        raise BacktestResultError(f"Failed to parse {filepath}: {e}")
        finally:
           self._cleanup_temp_dir(temp_dir)
        return self.data

    def _cleanup_temp_dir(self, temp_dir: Path) -> None:
        """
        Removes the temporary directory and its contents.

        Args:
            temp_dir: The path to temporary directory.
        """
        try:
            self.logger.debug(f"Cleaning up temporary directory: {temp_dir}")
            for file in temp_dir.iterdir():
                file.unlink()
            temp_dir.rmdir()
        except OSError as e:
            self.logger.warning(f"Failed to remove temporary directory {temp_dir}: {e}")

```

### 2. Data Models

This feature primarily involves file manipulation and parsing, so new Pydantic models are not strictly required for the `FTBacktestParser` itself. The structure of the parsed data (`self.data`) will mirror the JSON structure of the Freqtrade backtest result files. However, for a complete solution (beyond the scope of `FTBacktestParser`), Pydantic models _would_ be beneficial for:

- Representing the structure of the backtest results in a type-safe way.
- Validating the parsed JSON data against the expected schema.
- Providing a consistent interface for accessing backtest data in other parts of the backend (e.g., in API responses).

These models would be defined in `app/schemas`, likely within `schema_backtests.py` or a new file `schema_freqtrade.py` if the models are more generally applicable to Freqtrade data. This design document focuses on the `FTBacktestParser` itself and does not include these Pydantic models.

### 3. Integration Points

- **`app/tasks/backtests.py` (Celery Task):** The `run_backtest_task` Celery task, after successfully running a backtest and storing the result file path in the `BacktestsORM`, could use `FTBacktestParser` to:
  - Parse additional information.
  - Extract any summary information
  - Potentially update the `BacktestsORM` model for querying.

### 4. Agent Interaction

This feature does not directly interact with AI agents.

## Implementation Plan

1. **Phase 1: Core `FTBacktestParser` Implementation**

   - Task 1: Create `app/util/ft/ft_backtest_parser.py` and implement the `FTBacktestParser` class with the `__init__`, `_extract_zip`, `parse_all`, and `_cleanup_temp_dir` methods.
   - Task 2: Implement the `BacktestResultError` exception.
   - Task 3: Add comprehensive unit tests for `FTBacktestParser`, covering successful parsing, file not found scenarios, invalid ZIP file scenarios, and temporary directory cleanup.

2. **Phase 2: Integrate with the Celery task**
   - Task 4. Modify `app/tasks/backtests.py` to use the class.
   - Task 5. Verify, that the backtest data is parsed and handled.

## Observability

### Logging

- Log the start and completion of ZIP file extraction.
- Log the path to the temporary directory.
- Log any errors encountered during file parsing (using `self.logger.error`).
- Log warnings for issues encountered during temporary directory cleanup (using `self.logger.warning`).
- Log file names that are successfully parsed.
- Log any unexpected files found in the ZIP archive.

Example log entries (using the project's JSON logger format):

```json
{
  "timestamp": "2025-02-15T10:00:00Z",
  "level": "INFO",
  "component": "ft_backtest_parser",
  "message": "Extracting backtest result ZIP: /path/to/backtest_results/backtest_abc123.zip"
}

{
  "timestamp": "2025-02-15T10:00:01Z",
  "level": "DEBUG",
  "component": "ft_backtest_parser",
  "message": "Extracted ZIP to: /tmp/tmpabcdefg"
}

{
  "timestamp": "2025-02-15T10:00:02Z",
  "level": "ERROR",
  "component": "ft_backtest_parser",
  "message": "Failed to parse /tmp/tmpabcdefg/results.json: Expecting property name enclosed in double quotes: line 5 column 10 (char 123)",
  "data": {
      "file_path": "/tmp/tmpabcdefg/results.json",
      "error_type": "JSONDecodeError",
      "error_details": "Expecting property name enclosed in double quotes: line 5 column 10 (char 123)"
  }
}

{
    "timestamp": "2025-02-15T10:05:00Z",
    "level": "DEBUG",
    "component": "ft_backtest_parser",
    "message": "Cleaning up temporary directory: /tmp/tmpabcdefg"
}

{
  "timestamp": "2025-02-15T10:05:01Z",
  "level": "WARNING",
  "component": "ft_backtest_parser",
  "message": "Failed to remove temporary directory /tmp/tmpabcdefg: [Errno 16] Device or resource busy: '/tmp/tmpabcdefg'"
}
```

## Future Considerations

- **Pydantic Models:** Define Pydantic models for the backtest result data structure for type safety and easier data access.
- **Selective Parsing:** Allow specifying which files within the ZIP to parse, rather than parsing all JSON files.
- **Streaming Parsing:** For very large result files, consider using a streaming JSON parser (like `ijson`) to reduce memory usage.
- **Integration with Backtest Analysis:** The parsed data could be used to generate summary statistics, charts, or other visualizations.
- **Caching:** Consider caching parsed results to avoid repeated extraction and parsing if the same backtest results are requested multiple times. This would need to be carefully considered in relation to data updates.

## Dependencies

- `zipfile` (standard library)
- `tempfile` (standard library)
- `json` (standard library)
- `pathlib` (standard library)
- `app.util.logger` (project's logging utility)

## Security Considerations

- **File Paths:** The input `result_path` is assumed to be a trusted path generated by the backend. No user-provided paths are used directly.
- **ZIP Bomb Prevention:** While unlikely given the source of the ZIP files, the `zipfile` module in Python has built-in protections against "ZIP bombs" (archives designed to expand to enormous sizes). These protections should be sufficient, but can be reviewed.
- **Malformed JSON:** The `json` module will raise exceptions for malformed JSON, which are handled by the parser.

## Rollout Strategy

This feature can be rolled out incrementally:

1.  Implement the `FTBacktestParser` and its unit tests.
2.  Integrate it into the Celery task in a non-critical way (e.g., log the parsed data but don't yet use it for any functional changes).
3.  Add database fields / API endpoints to expose the parsed data.
4.  Update the frontend to display the new information.

## References

- [Freqtrade Backtesting Documentation](https://www.freqtrade.io/en/stable/backtesting/)
- [Python `zipfile` Module](https://docs.python.org/3/library/zipfile.html)
- [Python `tempfile` Module](https://docs.python.org/3/library/tempfile.html)
- [Python `pathlib` Module](https://docs.python.org/3/library/pathlib.html)
